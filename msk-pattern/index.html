<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="McLaren Labs of San Francisco">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>McLaren Synth Kit - Patterns - MSK</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/console.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/objc.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/objectivec.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/smalltalk.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">MSK</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Developer <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../setup/" class="dropdown-item">GNUstep Setup</a>
</li>
                                    
<li>
    <a href="../ask-midi/" class="dropdown-item">Alsa Sound Kit - MIDI</a>
</li>
                                    
<li>
    <a href="../ask-pcm/" class="dropdown-item">Alsa Sound Kit - PCM</a>
</li>
                                    
<li>
    <a href="../msk-over/" class="dropdown-item">McLaren Synth Kit - Overview</a>
</li>
                                    
<li>
    <a href="../msk-samples/" class="dropdown-item">McLaren Synth Kit - Samples</a>
</li>
                                    
<li>
    <a href="../msk-metronome/" class="dropdown-item">McLaren Synth Kit - Metronome</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">McLaren Synth Kit - Patterns</a>
</li>
                                    
<li>
    <a href="../msk-liveloop/" class="dropdown-item">McLaren Synth Kit - Liveloops</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../conclusion/" class="nav-link">Conclusion</a>
                            </li>
                            <li class="navitem">
                                <a href="../toc/" class="nav-link">Table Of Contents</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../msk-metronome/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../msk-liveloop/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/mclarenlabs/libs-mclaren-alpha/" class="nav-link"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#mclaren-synth-kit-patterns" class="nav-link">McLaren Synth Kit - Patterns</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#what-is-a-pattern" class="nav-link">What is a Pattern?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#synchronization-events" class="nav-link">Synchronization Events</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sub-patterns" class="nav-link">Sub-patterns</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#patterns-in-steptalk" class="nav-link">Patterns in StepTalk</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#running-patterns" class="nav-link">Running Patterns</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#logging-patterns" class="nav-link">Logging Patterns</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#what-can-execute-in-blocks" class="nav-link">What can execute in blocks?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#conclusion" class="nav-link">Conclusion</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#postscript" class="nav-link">Postscript</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="mclaren-synth-kit-patterns">McLaren Synth Kit - Patterns</h1>
<p>Using the Metronome directly is appropriate for obtaining tick-accurate timing and scheduling simple repeating sequences.  With the Metronome "beat" callback it is easy to construct a program that plays beats.</p>
<p>For more complex repeating patterns, the <code>Pattern</code> facility can be helpful, and can make creating repeating musical motifs more fun.</p>
<h2 id="what-is-a-pattern">What is a Pattern?</h2>
<p>A Pattern is a repeating sequence of instructions, some of which specify the passage of time, others execute code.  Patterns are built up by calling methods on a Pattern object.</p>
<p>In the snippet below, assume that there is Synthesizer object named <code>synth</code> that has a method <code>playNote:</code>.  The following defines a pattern that executes four times and then exits.</p>
<pre><code class="language-objc">MSKPattern *pat = [[MSKPattern alloc] initWithName:'pat1'];

[pat sync:@&quot;beat&quot;];
[pat thunk:^{
  [synth playNote:64];
  }];

[pat sync:@&quot;beat&quot;];
[pat thunk:^{
  [synth playNote:60];
  }];

[pat sync:@&quot;beat&quot;];
[pat thunk:^{
  [synth playNote:60];
  }];

[pat sync:@&quot;beat&quot;];
[pat thunk:^{
  [synth playNote:60];
  }];

[pat repeat:4];
</code></pre>
<p>The Pattern methods are a little-language for specifying how to synchronize with the Metronome.  This pattern says synchronize with a beat (beat 0) and then play note 64.  Then synchronize with the next beat (beat 1) and play note 60.  Because there are fourr <code>sync:</code> calls, the pattern synchronizes with each beat in a 4/4 measure.  The <code>repeat:</code> call is an annotation on the pattern that specifies its repeat factor.</p>
<p>A Pattern can also specify the passage of time in ways other than synchronizing with events.  A Pattern can spcify the passage of time in "ticks" or "realtime".</p>
<pre><code class="language-objc">MSKPattern *pat2 = [[MSKPattern alloc] initWithName:'pat2'];

[pat2 sync:@&quot;beat&quot;];
[pat2 thunk:^{ doSomething(); }];

[pat2 ticks:31];
[pat2 thunk:^{ doSomething(); }];

[pat2 seconds:1.3];
[pat2 thunk:^{ doSomethingElse(); }];

</code></pre>
<p>When run, the Pattern above synchronizes with the next Metronome beat and performs <code>doSomething()</code>.  It then sleeps for 31 ticks (remember, there are 120 ticks per quarter note) and performs <code>doSomething()</code> again.  It then sleeps for 1.3 seconds and then performs <code>doSomethingElse()</code>.</p>
<p>This pattern is not annotate with a <code>repeat:</code> repetition factor, so it executes once and exits.</p>
<h2 id="synchronization-events">Synchronization Events</h2>
<p>At the present time there are only a small number of named synchronization events.</p>
<ul>
<li>beat - the Metronome beat callback </li>
<li>downbeat - Metronome beat callback with beat==0</li>
<li>clock - the MIDI beat clock, 24 clocks per quarter</li>
</ul>
<h2 id="sub-patterns">Sub-patterns</h2>
<p>Patterns can call other patterns, which execute as subroutines.  The Pattern <code>pat:</code> method specifies a sub-pattern.  A sub-pattern blocks its parent until it is done.</p>
<p>Consider the following pattern.  It plays four sixteenth notes, synchronized with the next beat.</p>
<pre><code class="language-objc">MSKPattern *pat3 = [[MSKPattern alloc] initWithName:@&quot;pat3&quot;];
[pat3 sync:@&quot;beat&quot;];
[pat3 thunk:^{ [synth playNote:70; ]}];
[pat ticks:30];
[pat3 thunk:^{ [synth playNote:70; ]}];
[pat ticks:30];
[pat3 thunk:^{ [synth playNote:70; ]}];
[pat ticks:30];
[pat3 thunk:^{ [synth playNote:70; ]}];
</code></pre>
<p>This pattern could be incorporated into a parent pattern.  The pattern below plays a note on beat 0 and beat 1, on beat 2 it plays four sixteenths, and then on beat 3 it plays a note.  The pattern then repeats 4 times.</p>
<pre><code class="language-objc">MSKPattern *pat4 = [[MSKPattern alloc] initWithName:@&quot;pat4&quot;];

[pat4 sync:@&quot;beat&quot;];
[pat4 thunk:^{ [synth playNote:64; ]}];

[pat4 sync:@&quot;beat&quot;];
[pat4 thunk:^{ [synth playNote:60; ]}];

[pat4 pat:pat3]; // play the sixteenth notes

[pat4 sync:@&quot;beat&quot;];
[pat4 thunk:^{ [synth playNote:60; ]}];
</code></pre>
<h2 id="patterns-in-steptalk">Patterns in StepTalk</h2>
<p>StepTalk is a Smalltalk-dialect interpreter that can call Objective-C classes and methods.  Using Smalltalk syntax with Patterns is slightly prettier because of the "cascade" operator (operator semicolon ";" in Smalltalk).</p>
<p>With StepTalk, the first example of this chapter looks like the following.</p>
<pre><code class="language-smalltalk">pat := MSKPattern alloc initWithName:'pat1'.

pat
  sync: #beat;
  block: [ synth playNote:64. ];

  sync: #beat;
  block: [ synth playNote:60. ];

  sync: #beat;
  block: [ synth playNote:60. ];

  sync: #beat;
  block: [ synth playNote:60. ];

  repeat: 4.
</code></pre>
<p>Note: we haven't quite finished producing a working demo with the McLaren Synth Kit integrated with StepTalk, but when we do, this is what patterns will look like.</p>
<h2 id="running-patterns">Running Patterns</h2>
<p>So far, we have shown how to create patterns, but we haven't shown how to start them or stop them.  For that we need to create a Scheduler and attach it to a Metronome.  Once attached, the Scheduler TAKES OVER all of the callbacks of the Metronome and is controlled by the start/stop/kontinue methods of the Metronome.</p>
<p>Assume that we have previously created a Metronome named <code>_metro</code>.  Then the following creates a Scheduler.</p>
<pre><code class="language-objc">@property MSKScheduler *sched;

- (void) makeScheduler {

  _sched = [[Scheduler alloc] init];
  [_sched registerMetronome:_metro];
}
</code></pre>
<p>Patterns can be added to the Scheduler to be launched when the Scheduler starts.  The following shows how two patterns are added to a Scheduler to start when the Metronome starts.</p>
<pre><code class="language-objc">[_sched addLaunch:pat];
[_sched addLaunch:pat4];
</code></pre>
<p>The tempo of the playing and the starting and stopping are controlled through the underlying Metronome.</p>
<pre><code class="language-objc">[_metro setTempo:90 error:&amp;err];
[_metro start];
</code></pre>
<h2 id="logging-patterns">Logging Patterns</h2>
<p>By default, the Scheduler logs the progress of Patterns using <code>NSLog</code>.  This behavior can be changed by disabling the logging facility of the scheduler.</p>
<pre><code class="language-objc">_sched.log = NO;
</code></pre>
<p>When enabled, a detailed description of each pattern-related callback will be printed. Some sample output is shown below.  It was collected from the <code>test8</code> test in the Tests directory.</p>
<pre><code class="language-console">2024-03-11 09:15:38.176 test8[106681:106681]       0    0.0 pat1 #beat
2024-03-11 09:15:38.176 test8[106681:106681]       0    0.0    ONE
2024-03-11 09:15:38.176 test8[106681:106681]       0    0.0 pat2 #beat
2024-03-11 09:15:38.204 test8[106681:106683]       5    0.0 pat1 #clock
2024-03-11 09:15:38.204 test8[106681:106683]       5    0.0    CLOCK AFTER ONE
2024-03-11 09:15:38.843 test8[106681:106683]     120    0.1 pat2 #beat
2024-03-11 09:15:38.843 test8[106681:106683]     120    0.1 pat1 #beat
2024-03-11 09:15:38.843 test8[106681:106683]     120    0.1    TWO
2024-03-11 09:15:39.510 test8[106681:106683]     240    0.2 pat2 #beat
2024-03-11 09:15:39.510 test8[106681:106683]     240    0.2 sixt #beat
2024-03-11 09:15:39.676 test8[106681:106683]     270    0.2 sixt ticks
2024-03-11 09:15:39.843 test8[106681:106687]     300    0.2 sixt ticks
2024-03-11 09:15:40.010 test8[106681:106683]     330    0.2 sixt ticks
2024-03-11 09:15:40.176 test8[106681:106687]     360    0.3 pat2 #beat
2024-03-11 09:15:40.176 test8[106681:106687]     360    0.3 sixt #beat
2024-03-11 09:15:40.343 test8[106681:106683]     390    0.3 sixt ticks
2024-03-11 09:15:40.510 test8[106681:106687]     420    0.3 sixt ticks
2024-03-11 09:15:40.676 test8[106681:106683]     450    0.3 sixt ticks
2024-03-11 09:15:40.676 test8[106681:106683]     450    0.3    INTRO ONE
2024-03-11 09:15:41.143 test8[106681:106683]   2.967    1.0 pat2 seconds
</code></pre>
<p>Let's strip off the standard NSLog prefix and just look at the output of the scheduler.  The first column is the time in TICKS or SECONDS.  If the pattern event was due to a metronome synchronization or song-position time then the time is reported in ticks.  If it is a realtime event, then the time is reported in seconds.</p>
<p>The next column is the song position in measures and beats.  Both start at 0.  Here we are in 4/4 time so the beat repeats after 3.</p>
<p>The third column is the name of the pattern executing.  We see patterns named 'pat1', 'pat2' and 'sixt' in the example.</p>
<p>The fourth column is the synchronization event: either an event name like "#beat" or a delay operator name like "ticks" or "seconds".</p>
<pre><code class="language-console">       0    0.0 pat1 #beat
       0    0.0    ONE
       0    0.0 pat2 #beat
       5    0.0 pat1 #clock
       5    0.0    CLOCK AFTER ONE
     120    0.1 pat2 #beat
     120    0.1 pat1 #beat
     120    0.1    TWO
     240    0.2 pat2 #beat
     240    0.2 sixt #beat
     270    0.2 sixt ticks
     300    0.2 sixt ticks
     330    0.2 sixt ticks
     360    0.3 pat2 #beat
     360    0.3 sixt #beat
     390    0.3 sixt ticks
     420    0.3 sixt ticks
     450    0.3 sixt ticks
     450    0.3    INTRO ONE
   2.967    1.0 pat2 seconds
</code></pre>
<h2 id="what-can-execute-in-blocks">What can execute in blocks?</h2>
<p>As with the Metronome callbacks, the Scheduler "thunk" invocations are also performed on the MIDI dispatch queue by default.  As a programmer, you should take care to not perform operations in the thunk that could block execution or interfere with other threads.</p>
<p>Calls to <code>NSLog</code> are generally alright during development.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The Pattern mechanism abstracts the calllbacks of the Metronome and provides a little-language for specifying rhythmic phrases.  The pattern mechanism only specifies the passage of time in varying ways and leaves the execution of what to do at an instant up to an open-ended block invocation.  This leaves open the option to launch context sounds, control model parameters, or do other things.</p>
<p>Because Patterns are tied to the MIDI clock of the ALSA Seq, Patterns provide tick-accurate timing in a user-friendly way.</p>
<h2 id="postscript">Postscript</h2>
<p>Patterns are a very recent addition to the McLaren Synth Kit, and are more likely subject to change more than other parts of the kit.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>(c) McLaren Labs 2024</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
