<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="McLaren Labs of San Francisco">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>McLaren Synth Kit - Metronome - MSK</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/console.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/objc.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/smalltalk.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">MSK</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Developer <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../setup/" class="dropdown-item">GNUstep Setup</a>
</li>
                                    
<li>
    <a href="../ask-midi/" class="dropdown-item">Alsa Sound Kit - MIDI</a>
</li>
                                    
<li>
    <a href="../ask-pcm/" class="dropdown-item">Alsa Sound Kit - PCM</a>
</li>
                                    
<li>
    <a href="../msk-over/" class="dropdown-item">McLaren Synth Kit - Overview</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">McLaren Synth Kit - Metronome</a>
</li>
                                    
<li>
    <a href="../msk-pattern/" class="dropdown-item">McLaren Synth Kit - Patterns</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../conclusion/" class="nav-link">Conclusion</a>
                            </li>
                            <li class="navitem">
                                <a href="../toc/" class="nav-link">Table Of Contents</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../msk-over/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../msk-pattern/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/mclarenlabs/libs-mclaren-alpha/" class="nav-link"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#mclaren-synth-kit-metronome" class="nav-link">McLaren Synth Kit - Metronome</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#time-types" class="nav-link">Time Types</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#midi-clock" class="nav-link">MIDI Clock</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#the-msk-metronome" class="nav-link">The MSK Metronome</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#the-metronome-dispatch-queue" class="nav-link">The Metronome Dispatch Queue</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#controlling-the-metronome" class="nav-link">Controlling the Metronome</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#instantiating-a-metronome" class="nav-link">Instantiating a Metronome</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="mclaren-synth-kit-metronome">McLaren Synth Kit - Metronome</h1>
<p>The MSK Metronome provides a high-precision timing source that is linked to the ALSA MIDI clock.  With it, you can produce tick-accurate timing of MIDI events.</p>
<h2 id="time-types">Time Types</h2>
<p>The Linux ALSA Sequencer interface provides many complex functions.  In addition to sending and receiving MIDI events, the SEQ interface provides functions for manipulating how MIDI events are handled in a timing queue.</p>
<p>There are two distinct time types in the MIDI system</p>
<ul>
<li>tick time</li>
<li>realtime</li>
</ul>
<p>Ticks are related to the beats of music.  By default, a SEQ is set up with 120 PPQ (parts-per-quarter) note.  When playing back events in a queue, the tempo of the queue determines the rate at which ticks are replayed.</p>
<p>Realtime maps events to absolute times (in seconds and nanoseconds) that are independent of the current tempo of the music.</p>
<h2 id="midi-clock">MIDI Clock</h2>
<p>There is another time base in the system: the <a href="https://en.wikipedia.org/wiki/MIDI_beat_clock">MIDI clock</a>.  By definition, there are 24 MIDI clocks per quarter note.</p>
<p>With our default system set up, a MIDI clock occurs every 5 ticks, and a quarter note occurs every 24 clocks.</p>
<h2 id="the-msk-metronome">The MSK Metronome</h2>
<p>The MSK Metronome uses the timing of MIDI ticks to produce a beat-based timebase that can be used in any way you see fit.  Furthermore, the Metronome also has the notion of a time signature (4/4, 3/4, etc) to help map ticks to beats and measures.</p>
<p>The beat callback of the Metronome looks like this when used.</p>
<pre><code class="language-objc">metro.setTimesig:4 den:4;  // set 4/4 time

[metro onBeat:^(unsigned tick, int beat, int measure) {
   if (beat == 0)
     NSLog(@&quot;down beat&quot;);
   else
     NSLog(@&quot;beat: %d&quot;, beat)
  }]
</code></pre>
<p>When run, the metronome will start counting from beat 0 at tick 0 and will increment the measure every four beats.  The tick value returned is the running tick time with 120 PPQ.</p>
<p>The Metronome can also produce a MIDI clock callback.</p>
<pre><code class="language-objc">[metro onClock:^(unsigned tick, int clock, int beat, int measure) {
   ...
   }];
</code></pre>
<p>The clock will run from 0..23 for each beat.</p>
<h2 id="the-metronome-dispatch-queue">The Metronome Dispatch Queue</h2>
<p>Events from the Metronome are dispatched from the dispatch queue of the underlying <code>ASKSeq</code>.  By default, this is a dedicated queue called "midi" for events handled by the ASK system.</p>
<p>It is important to be aware of the fact that callbacks from the Metronome are run on this queue.</p>
<h2 id="controlling-the-metronome">Controlling the Metronome</h2>
<p>The Metronome has the following methods to control its operation.</p>
<ul>
<li>start</li>
<li>stop</li>
<li>kontinue</li>
</ul>
<p>Each of these maps to operations on the underlying ALSA queue attached to the SEQ of the Metronome.  A side-effect of this design is that if your code is using the same queue for other things, starting and stopping the metronome will start and stop those events.  This is normally a good thing when the Metronome is the driving timebase for your system.</p>
<h2 id="instantiating-a-metronome">Instantiating a Metronome</h2>
<p>The <code>MSKMetronome</code> does not create an ALSA Seq on its own.  It needs to have one provided for it.</p>
<p>The following two methods illustrate a typical way a Seq and a Metronome would be created using the McLarenSynthKit.  The <code>makeSeq</code> method creates a Seq, whose only customizatin is that it is named "metronome."  This Seq is available for regular event sending and receiving, etc.</p>
<p>The <code>makeMetronome</code> method is initialized with the Seq previously created.  Callbacks can then be attached to the Metronome, and the start/stop/kontinue methods can be used to control its play position.</p>
<pre><code class="language-objc">- (void) makeSeq {

  ASKSeqOptions *options = [[ASKSeqOptions alloc] init];
  options-&gt;_sequencer_name = &quot;metronome&quot;;

  NSError *error;
  _seq = [[ASKSeq alloc] initWithOptions:options error:&amp;error];
  if (error != nil) {
    NSLog(@&quot;Could not create sequencer.  Error:%@&quot;, error);
    exit(1);
  }
}

- (void) makeMetronome {

  NSError *error;
  _metro = [[MSKMetronome alloc] initWithSeq:_seq error:&amp;error];

  // set tempo
  NSError *err;
  [_seq setTempo:90 error:&amp;err];

  if (error != nil) {
    NSLog(@&quot;Could not create metronome. Error:%@&quot;, error);
    exit(1);
  }
}
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>(c) McLaren Labs 2024</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
